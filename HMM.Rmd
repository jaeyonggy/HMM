---
title: "HMM"
subtitle: "Ch.1 PRELIMINARIES: MIXTURES AND MARKOV CHAINS"
author: "Jaeyong Lee"
output:
  html_notebook:
    toc: yes
    code_folding: "none"
---

<style type="text/css">
h1.title {
  font-size: 30px;
  text-align: center;
}
h3.subtitle {
  font-size: 20px;
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
    font-size: 18px;
  text-align: right;
}
body{
   font-size: 17px;  # body is for normal text
}
td{
   font-size: 12px;  # td is for table data
}
</style>

\
\

### Mixture model

\

Earthquake data:

```{r}
library(fpp2)
raw <- c(13,14,8,10,16,26,32,27,18,32,36,24,22,23,22,18,25,21,21,14,
          8,11,14,23,18,17,19,20,22,19,13,26,13,14,22,24,21,22,26,21,
          23,24,27,41,31,27,35,26,28,36,39,21,17,22,17,19,15,34,10,15,
          22,18,15,20,15,22,19,16,30,27,29,23,20,16,21,21,25,16,18,15,
          18,14,10,15,8,15,6,11,8,7,18,16,13,12,13,20,15,16,12,18,
          15,16,13,15,16,11,11)
data <- ts(raw, start=1900, frequency=1)
data
```

```{r}
autoplot(data)
```

\
\
\

#### The estimation of the parameters of a mixture distribution

\

The following is an implementation of fitting a mixture of four Poisson distributions

\

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss2.png)

\
\

```{r}
# Function to compute -log(likelihood)
mllk <- function(wpar,x){ 
  zzz <- w2n(wpar)
  return(-sum(log(outer(x,zzz$lambda,dpois)%*%zzz$delta)))
}
# the use of the function outer() makes it possible to evaluate a Poisson mixture log-likelihood in a single compact expression rather than a loop.

# Function to transform natural to working parameters
n2w  <- function(lambda,delta){
  log(c(lambda,delta[-1]/(1-sum(delta[-1]))))
}

# Function to transform working to natural parameters
w2n  <- function(wpar){
  m <- (length(wpar)+1)/2
  lambda <- exp(wpar[1:m])
  delta  <- exp(c(0,wpar[(m+1):(2*m-1)]))
  return(list(lambda=lambda,delta=delta/sum(delta))) 
}

# Read data, specify starting values, minimize -log(likelihood), and transform to natural parameters
wpar <- n2w(c(10,20,25,30),c(1,1,1,1)/4)
w2n(nlm(mllk,wpar,raw)$estimate)  # raw: the earthquake data
```

\

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss1.png)

\
\
\

#### Fitting the mixture model over the earthquake data

\

```{r}
hist(raw, freq=F, xlim=c(0,50))
```

\
\

My implementation of four-poisson mixture distribution with estimated parameters from above

```{r}
obs_from_poimix <- function(probs, lambdas, howmany){
  obs_mix <- c()  # vector to contain the obs from the mix distribution
  for(i in 1:howmany){
    which_poi <- sample(c(1:length(probs)), size=1, prob=probs)
    obs_mix <- c(obs_mix, rpois(1, lambdas[which_poi]))  # equivalent to python's appending to a list
  }
  return(obs_mix)
}
```

```{r}
# m = 4
set.seed(0)
probs <- c(0.093,0.354,0.437,0.116)
lambdas <- c(10.584, 15.528, 20.969, 32.079)
howmany <- length(raw)

obs_mix <- obs_from_poimix(probs, lambdas, howmany)
hist(raw, freq=F, ylim=c(0,0.08))
lines(density(obs_mix), col="red")
```

```{r}
# m = 2
set.seed(0)
probs <- c(0.676, 0.324) 
lambdas <- c(15.777, 26.840)
howmany <- length(raw)

obs_mix <- obs_from_poimix(probs, lambdas, howmany)
hist(raw, freq=F, ylim=c(0,0.08))
lines(density(obs_mix), col="red")
```

\
\
\
\

### Markov chains

\

#### Definition

\

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss4.png)

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss5.png)

\

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss3.png)

\
\
\

#### Finding the stationary distribution

\

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss6.png)

\
\

```{r}
P <- matrix(c(1/3,1/3,1/3,2/3,0,1/3,1/2,1/2,0),nrow=3,byrow=T)
P
```

```{r}
mpow <- function(mat, times){
  temp <- mat
  for(i in 1:(times-1)){
    mat <- mat %*% temp
  }
  return(mat)
}
```

```{r}
mpow(P,5); mpow(P, 15); mpow(P, 25); mpow(P, 100); (1/32)*c(15,9,8) # the stationary distribution of the tpm
```

\
\
\
\

### Estimating transition probabilities

\

![](/Users/jaeyonglee/Documents/College/RStudio/HMM/HMM/images/ss7.png)

\
\















